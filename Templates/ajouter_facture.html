<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Cr√©er une facture</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
    }
    .btn-orange {
      background-color: #fd7e14;
      color: white;
    }
    .btn-orange:hover {
      background-color: #e96b00;
    }
    .flash-success {
      background-color: #d4edda;
      border-left: 5px solid #28a745;
      padding: 10px;
      margin-bottom: 10px;
    }
    .flash-error {
      background-color: #f8d7da;
      border-left: 5px solid #dc3545;
      padding: 10px;
      margin-bottom: 10px;
    }
    .form-label.required::after {
      content: " *";
      color: red;
    }
  </style>
</head>
<body class="container py-5">
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999">
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% for category, message in messages %}
      <div class="toast align-items-center text-white {{ 'bg-success' if category == 'success' else 'bg-danger' }} border-0 show" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
          <div class="toast-body">
            {{ message }}
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      </div>
    {% endfor %}
  {% endwith %}
</div>

<h2 class="mb-4 text-orange">üßæ Cr√©er une facture</h2>
<a href="{{ url_for('index') }}" class="btn btn-outline-warning mb-3">‚¨Ö Retour √† l'accueil</a>

<form method="POST" action="/ajouter-facture" class="bg-white p-4 rounded shadow-sm needs-validation" novalidate>
  <div class="row mb-3">
    <div class="col-md-6">
      <label class="form-label required">Nom du client :</label>
      <select name="client_id" class="form-select" required>
        <option value="">-- S√©lectionner un client --</option>
        {% for client in clients %}
          <option value="{{ client[0] }}">{{ client[1] }}</option>
        {% endfor %}
      </select>
      <div class="invalid-feedback">Ce champ est requis.</div>
    </div>
    <div class="col-md-6">
      <label class="form-label required">Num√©ro de facture :</label>
      <input type="text" name="numero" class="form-control" required placeholder="Dernier : {{ dernier_numero }}">
      <div class="invalid-feedback">Ce champ est requis.</div>
    </div>
  </div>

  <div class="row mb-3">
    <div class="col-md-6">
      <label class="form-label required">Date :</label>
      <input type="date" name="date_facture" class="form-control" required>
      <div class="invalid-feedback">Ce champ est requis.</div>
    </div>
    <div class="col-md-6">
      <label class="form-label required">Matricule du camion :</label>
      <input type="text" name="matricule" class="form-control" required>
      <div class="invalid-feedback">Ce champ est requis.</div>
    </div>
  </div>

  <div class="row mb-3">
    <div class="col-md-6">
      <label class="form-label required">Matricule du remorque :</label>
      <input type="text" name="remorque" class="form-control" required>
      <div class="invalid-feedback">Ce champ est requis.</div>
    </div>
    <div class="col-md-6">
      <label class="form-label required">Description :</label>
      <textarea class="form-control" name="description" rows="3" required></textarea>
      <div class="invalid-feedback">Ce champ est requis.</div>
    </div>
  </div>

  <div class="row mb-3">
    <div class="col-md-6">
      <label class="form-label required">Ligne de d√©part :</label>
      <input type="text" name="ligne_depart" class="form-control" required>
      <div class="invalid-feedback">Ce champ est requis.</div>
    </div>
    <div class="col-md-6">
      <label class="form-label required">Ligne d'arriv√©e :</label>
      <input type="text" name="ligne_arrivee" class="form-control" required>
      <div class="invalid-feedback">Ce champ est requis.</div>
    </div>
  </div>

  <div class="row mb-3">
    <div class="col-md-4">
      <label class="form-label required">Montant HT :</label>
      <input type="number" step="0.01" name="montant" class="form-control" required>
      <div class="invalid-feedback">Ce champ est requis.</div>
    </div>
    <div class="col-md-4">
      <label class="form-label required">TVA (%) :</label>
      <input type="number" step="0.01" name="tva" class="form-control" required>
      <div class="invalid-feedback">Ce champ est requis.</div>
    </div>
    <div class="col-md-4">
      <label class="form-label required">Devise :</label>
      <select name="devise" class="form-select" required>
        <option value="">-- Choisir --</option>
        <option value="MAD">Dirham (MAD)</option>
        <option value="EUR">Euro (EUR)</option>
        <option value="USD">Dollar (USD)</option>
      </select>
      <div class="invalid-feedback">Ce champ est requis.</div>
    </div>
    
      <label class="form-label required">Statut :</label>
      <select name="statut" class="form-select" required>
        <option value="">-- Choisir --</option>
        <option value="pay√©e">Pay√©e</option>
        <option value="impay√©e">Impay√©e</option>
      </select>
      <div class="invalid-feedback">Ce champ est requis.</div>
    </div>
  </div>

  <button type="submit" class="btn btn-orange">üíæ Enregistrer la facture</button>
</form>

<div class="mt-5">
  <h4>üìÑ Afficher les factures</h4>
  <button class="btn btn-outline-warning mb-3" onclick="afficherFactures()">üìÇ Voir les factures</button>
  <div id="zoneFactures" style="display:none;">
    <div class="table-responsive">
      <table class="table table-bordered table-striped align-middle">
        <thead class="table-light">
          <tr>
            <th>Num√©ro</th>
            <th>Date</th>
            <th>Nom du client</th>
            <th>Camion</th>
            <th>Remorque</th>
            <th>Description</th>
            <th>Ligne de d√©part</th>
            <th>Ligne d'arriv√©e</th>
            <th>Montant HT</th>
            <th>TVA</th>
            <th>Montant TTC</th>
            <th>Devise</th>
            <th>Date √âch√©ance</th>
            <th>Statut</th>
          </tr>
        </thead>
        <tbody id="facturesTable"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
  async function afficherFactures() {
    const tableDiv = document.getElementById("zoneFactures");
    const tbody = document.getElementById("facturesTable");

    if (tableDiv.style.display === "none") {
      const response = await fetch('/api/factures');
      const data = await response.json();
      tbody.innerHTML = "";
      data.factures.forEach(facture => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${facture.numero}</td>
          <td>${facture.date}</td>
          <td>${facture.nom_societe}</td>
          <td>${facture.camion}</td>
          <td>${facture.remorque}</td>
          <td>${facture.description}</td>
          <td>${facture.ligne_depart}</td>
          <td>${facture.ligne_destination}</td>
          <td>${facture.montant}</td>
          <td>${facture.tva}</td>
          <td>${facture.montant_ttc}</td>
          <td>${facture.devise}</td>
          <td>${facture.date_echeance}</td>
          <td>${facture.statut}</td>
        `;
        tbody.appendChild(row);
      });
      tableDiv.style.display = "block";
    } else {
      tableDiv.style.display = "none";
    }
  }

  // Activer les toasts Bootstrap
  const toastElList = [].slice.call(document.querySelectorAll('.toast'));
  toastElList.forEach(toastEl => new bootstrap.Toast(toastEl).show());

  // Validation Bootstrap personnalis√©e
  (() => {
    'use strict';
    const forms = document.querySelectorAll('.needs-validation');
    Array.from(forms).forEach(form => {
      form.addEventListener('submit', event => {
        if (!form.checkValidity()) {
          event.preventDefault();
          event.stopPropagation();
        }
        form.classList.add('was-validated');
      }, false);
    });
  })();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
